<div class="min-h-screen bg-gray-50" 
     data-controller="social" 
     data-social-post-id-value="<%= @post.id %>"
     data-social-liked-value="<%= @post.liked_by?(current_user) %>"
     data-social-likes-count-value="<%= @post.likes_count %>">
  <div class="container mx-auto px-4 py-6 lg:py-8">
    <div class="max-w-6xl mx-auto">
      <!-- Navigation -->
      <div class="flex items-center justify-between mb-6">
        <%= link_to posts_path, 
            class: "flex items-center gap-2 text-blue-600 hover:text-blue-800 transition-colors" do %>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Back to Gallery
        <% end %>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2">
          <!-- Post Header -->
          <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <div class="flex flex-wrap items-center gap-2 mb-4">
              <span class="px-3 py-1 rounded-full text-sm font-medium <%= @post.tutorial? ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800' %>">
                <%= @post.post_type.humanize %>
              </span>
              <% if @post.tutorial? && @post.difficulty_level %>
                <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm font-medium">
                  <%= @post.difficulty_level.humanize %>
                </span>
              <% end %>
            </div>
            
            <h1 class="text-2xl lg:text-3xl font-bold text-gray-900 mb-4 leading-tight">
              <%= @post.title %>
            </h1>
            
            <!-- Author and Meta Info -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
              <div class="flex items-center gap-3">
                <%= link_to posts_path(user: @post.user.username), 
                    class: "flex items-center gap-3 hover:bg-gray-50 rounded-lg p-2 -m-2 transition-colors" do %>
                  <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white font-bold">
                    <%= @post.user.username.first.upcase %>
                  </div>
                  <div>
                    <div class="font-semibold text-gray-900"><%= @post.user.username %></div>
                    <div class="text-sm text-gray-500">
                      <%= @post.created_at.strftime("%B %d, %Y") %> • 
                      <%= time_ago_in_words(@post.created_at) %> ago
                    </div>
                  </div>
                <% end %>
              </div>
              
              <div class="flex items-center gap-4">
                <button data-social-target="likeButton"
                        data-action="click->social#toggleLike"
                        class="flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors group">
                  <span data-social-target="likeIcon" class="text-lg group-hover:scale-110 transition-transform">
                    <%= @post.liked_by?(current_user) ? '❤️' : '🤍' %>
                  </span>
                  <span data-social-target="likeCount" class="font-semibold"><%= @post.likes_count %></span>
                </button>
                <div class="flex items-center gap-2 text-gray-600">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                  </svg>
                  <span class="font-semibold" data-comments-count><%= @post.comments_count %></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Post Images -->
          <% if @post.images.any? %>
            <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6">
              <% if @post.images.count == 1 %>
                <div class="aspect-video bg-gray-100 flex items-center justify-center">
                  <%= image_tag @post.images.first, 
                      class: "max-w-full max-h-full object-contain",
                      alt: @post.title %>
                </div>
              <% else %>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-1">
                  <% @post.images.each_with_index do |image, index| %>
                    <div class="aspect-square bg-gray-100 overflow-hidden <%= 'md:col-span-2' if index == 0 && @post.images.count.odd? %>">
                      <%= image_tag image, 
                          class: "w-full h-full object-cover hover:scale-105 transition-transform duration-300 cursor-pointer",
                          alt: "#{@post.title} - Image #{index + 1}",
                          onclick: "openImageModal('#{rails_blob_url(image)}', '#{@post.title} - Image #{index + 1}')" %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>

          <!-- Post Description -->
          <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">About this creation</h2>
            <div class="prose max-w-none text-gray-700 leading-relaxed">
              <%= simple_format(@post.description) %>
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1">
          <!-- Post Metadata -->
          <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Details</h3>
            <div class="space-y-3">
              <div class="flex justify-between">
                <span class="text-gray-600">Type</span>
                <span class="font-medium text-gray-900"><%= @post.post_type.humanize %></span>
              </div>
              <% if @post.tutorial? && @post.difficulty_level %>
                <div class="flex justify-between">
                  <span class="text-gray-600">Difficulty</span>
                  <span class="font-medium text-gray-900"><%= @post.difficulty_level.humanize %></span>
                </div>
              <% end %>
              <div class="flex justify-between">
                <span class="text-gray-600">Published</span>
                <span class="font-medium text-gray-900"><%= @post.created_at.strftime("%b %d, %Y") %></span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Views</span>
                <span class="font-medium text-gray-900">-</span>
              </div>
            </div>
          </div>

          <!-- Tags -->
          <% if @post.tags.any? %>
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Tags</h3>
              <div class="flex flex-wrap gap-2">
                <% @post.tags.each do |tag| %>
                  <%= link_to posts_path(tag: tag.name), 
                      class: "inline-flex items-center px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-sm transition-colors" do %>
                    #<%= tag.name %>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- Share Options -->
          <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Share</h3>
            <div class="flex gap-2">
              <button onclick="copyToClipboard('<%= post_url(@post) %>')" 
                      class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                Copy Link
              </button>
              <button onclick="sharePost()" 
                      class="flex-1 bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                Share
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Full width sections -->
      <div class="max-w-4xl mx-auto">

        <!-- Comments Section -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
          <h3 class="text-xl font-semibold mb-6 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
            Comments (<span data-comments-count><%= @post.comments_count %></span>)
          </h3>
          
          <!-- Comment Form -->
          <div class="mb-8 pb-6 border-b border-gray-200">
            <%= form_with model: [@post, @comment], 
                local: true, 
                class: "space-y-4",
                data: { 
                  social_target: "commentForm",
                  action: "submit->social#submitComment"
                } do |form| %>
              <div>
                <%= form.text_area :content, 
                    placeholder: "Share your thoughts about this creation...",
                    class: "w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none",
                    rows: 3 %>
              </div>
              <div class="flex justify-end">
                <%= form.submit "Post Comment", 
                    class: "bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg transition-colors" %>
              </div>
            <% end %>
          </div>

          <!-- Comments List -->
          <div class="space-y-6" data-social-target="commentsList">
            <% if @post.comments.any? %>
              <% @post.comments.includes(:user).order(created_at: :desc).each do |comment| %>
                <div class="flex gap-3 comment-item">
                  <div class="w-8 h-8 bg-gradient-to-br from-green-400 to-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold flex-shrink-0">
                    <%= comment.user.username.first.upcase %>
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="bg-gray-50 rounded-xl p-4">
                      <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                          <%= link_to posts_path(user: comment.user.username), 
                              class: "font-semibold text-gray-900 hover:text-blue-600 transition-colors" do %>
                            <%= comment.user.username %>
                          <% end %>
                          <span class="text-gray-500 text-sm">
                            <%= time_ago_in_words(comment.created_at) %> ago
                          </span>
                        </div>
                        <% if comment.can_be_deleted_by?(current_user) %>
                          <%= link_to [@post, comment], 
                              method: :delete,
                              data: { 
                                action: "click->social#deleteComment"
                              },
                              class: "text-gray-400 hover:text-red-500 transition-colors p-1 rounded",
                              title: "Delete comment" do %>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                          <% end %>
                        <% end %>
                      </div>
                      <p class="text-gray-700 leading-relaxed"><%= simple_format(comment.content) %></p>
                    </div>
                  </div>
                </div>
              <% end %>
            <% else %>
              <div class="text-center py-8 text-gray-500">
                <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
                <p>No comments yet. Be the first to share your thoughts!</p>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Related Posts -->
        <% if @related_posts.any? %>
          <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-xl font-semibold mb-6 flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
              </svg>
              Related Posts
            </h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
              <% @related_posts.each do |post| %>
                <article class="group">
                  <%= link_to post_path(post), class: "block" do %>
                    <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden mb-3">
                      <% if post.primary_image %>
                        <%= image_tag post.primary_image, 
                            class: "w-full h-full object-cover group-hover:scale-105 transition-transform duration-300",
                            alt: post.title %>
                      <% else %>
                        <div class="w-full h-full flex items-center justify-center text-gray-400">
                          <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />
                          </svg>
                        </div>
                      <% end %>
                    </div>
                    <h4 class="font-semibold text-sm text-gray-900 mb-1 group-hover:text-blue-600 transition-colors line-clamp-2">
                      <%= post.title %>
                    </h4>
                    <p class="text-gray-600 text-xs">by <%= post.user.username %></p>
                  <% end %>
                </article>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
  <div class="relative max-w-4xl max-h-full">
    <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white hover:text-gray-300 z-10">
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
    <img id="modalImage" src="" alt="" class="max-w-full max-h-full object-contain">
  </div>
</div>

<script>
// Image modal functions
function openImageModal(src, alt) {
  const modal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');
  modalImage.src = src;
  modalImage.alt = alt;
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeImageModal() {
  const modal = document.getElementById('imageModal');
  modal.classList.add('hidden');
  document.body.style.overflow = 'auto';
}

// Copy to clipboard function
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(function() {
    // Show success message
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Copied!';
    button.classList.add('bg-green-100', 'text-green-700');
    setTimeout(() => {
      button.textContent = originalText;
      button.classList.remove('bg-green-100', 'text-green-700');
    }, 2000);
  });
}

// Share function
function sharePost() {
  if (navigator.share) {
    navigator.share({
      title: '<%= @post.title %>',
      text: '<%= truncate(@post.description, length: 100) %>',
      url: '<%= post_url(@post) %>'
    });
  } else {
    copyToClipboard('<%= post_url(@post) %>');
  }
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeImageModal();
  }
});

// Close modal on background click
document.getElementById('imageModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeImageModal();
  }
});
</script>
